name: publish

concurrency: publish

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger only on version tags (e.g., v1.2.3)

permissions:
  id-token: write  # Grants write access to id-token for provenance
  contents: read   # Ensures the workflow can read repository contents

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment: publish
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Extract tag version
      id: tag_version
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
        echo "Tag version: $TAG_VERSION"
    
    - name: Get package.json version
      id: package_version
      run: |
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
        echo "Package.json version: $PACKAGE_VERSION"
    
    - name: Compare versions
      run: |
        if [ "${{ steps.tag_version.outputs.version }}" != "${{ steps.package_version.outputs.version }}" ]; then
          echo "Error: Tag version (${{ steps.tag_version.outputs.version }}) does not match package.json version (${{ steps.package_version.outputs.version }})"
          exit 1
        fi
        echo "Version match confirmed: ${{ steps.tag_version.outputs.version }}"
    
    - uses: actions/setup-node@v3
      with:
        node-version: '22.20.0'
        registry-url: 'https://registry.npmjs.org/'
    
    - run: npm cache clean --force
    - run: npm i
    - run: npm run build

    - name: Run ava tests
      run: npm run test:ava
    
    - name: Run tests
      run: npm test
    
    - run: npm publish --provenance
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}