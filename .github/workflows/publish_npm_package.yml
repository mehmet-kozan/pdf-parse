name: Publish NPM Package

concurrency: publish

on:
  push:
    tags:
      - "v*.*.*" # Trigger only on version tags

permissions:
  id-token: write # Grants write access to id-token for provenance
  contents: read # Ensures the workflow can read repository contents

jobs:
  integration_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22, 23, 24]

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          show-progress: false

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          package-manager-cache: false

      - name: Clean NPM Cache
        run: npm cache clean --force

      - name: Install
        run: npm i

      - name: Unit tests
        run: npm test

      - name: Integration tests
        run: npm run test:i

  publish:
    runs-on: ubuntu-latest
    needs: integration_test
    environment: publish
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          show-progress: false

      - name: Extract tag version
        id: tag_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Get package.json version
        id: package_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Package.json version: $PACKAGE_VERSION"

      - name: Compare versions
        run: |
          if [ "${{ steps.tag_version.outputs.version }}" != "${{ steps.package_version.outputs.version }}" ]; then
            echo "Error: Tag version (${{ steps.tag_version.outputs.version }}) does not match package.json version (${{ steps.package_version.outputs.version }})"
            exit 1
          fi
          echo "Version match confirmed: ${{ steps.tag_version.outputs.version }}"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22.20.0"
          package-manager-cache: false
          registry-url: "https://registry.npmjs.org"

      - name: Clean NPM Cache
        run: npm cache clean --force

      - name: Install
        run: npm i

      - name: Unit Tests
        run: npm test

      - run: npm publish --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
